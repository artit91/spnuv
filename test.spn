let spnuv = dynld("spnuv");
let loop = spnuv.Loop.defaultLoop();
let server = spnuv.TCP.new(loop);
let host = "0.0.0.0";
let port = 8080;

server.bind(host, port);

print("server listening on ", host, ":", port);
server.listen(fn err {
    if (err != nil) {
        print("connection error: ", err);
        return;
    }
    print("new connection");
    let client = spnuv.TCP.new(loop);
    server.accept(client);
    print("new client");
    client.read(fn err data {
        if (err != nil) {
            print("read error: ", err);
            return;
        }
        if (data != nil) {
            print("new data: ", data);
            print("writing data: ", data);
            client.write(data);
            print("data has written");
        }
    });
});

loop.run();